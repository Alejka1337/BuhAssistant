# –≠—Ç–∞–ø 1: Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 5 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ (–≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### Backend ‚úÖ

#### 1. –ú–æ–¥–µ–ª—å AnonymousPushToken
**–§–∞–π–ª:** `backend/app/models/push_token.py`

```python
class AnonymousPushToken(Base):
    __tablename__ = "anonymous_push_tokens"
    
    id = Column(Integer, primary_key=True)
    token = Column(String, unique=True, nullable=False)
    platform = Column(String, nullable=False)  # ios, android, web
    device_id = Column(String, nullable=True)
    created_at = Column(DateTime, server_default=func.now())
    last_active_at = Column(DateTime, onupdate=func.now())
    is_linked_to_user = Column(Integer, nullable=True)  # user_id –ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏
```

#### 2. –ú–∏–≥—Ä–∞—Ü–∏—è Alembic
**–§–∞–π–ª:** `backend/migrations/versions/2025_12_05_1948-fa87c57590bf_add_anonymous_push_tokens.py`
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `anonymous_push_tokens` —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `token` (unique), `device_id`
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –ë–î

#### 3. API Endpoints
**–§–∞–π–ª:** `backend/app/api/push.py`

–ù–æ–≤—ã–µ endpoints:
- `POST /api/push/register-anonymous` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- `POST /api/push/link-to-user` - –ø—Ä–∏–≤—è–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∫ user –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–µ

#### 4. –°–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–∫–∏
**–§–∞–π–ª:** `backend/app/services/push_notification.py`

–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `send_news_to_all(db, title, body, data)` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –í–°–ï–ú (users + anonymous)
- `send_deadline_notifications(db, title, body, data)` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤ —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º

---

### Frontend ‚úÖ

#### 1. Push Service
**–§–∞–π–ª:** `utils/pushService.ts`

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `registerForPushNotificationsAsync()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –æ—Ç Expo
- `registerAnonymousPushToken(token)` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ backend
- `linkAnonymousTokenToUser(token, authToken)` - –ø—Ä–∏–≤—è–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–µ
- `registerUserPushToken(token, authToken)` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è user
- `initializePushNotifications(isAuth, authToken)` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- `setupNotificationHandlers()` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### 2. AuthContext –æ–±–Ω–æ–≤–ª–µ–Ω
**–§–∞–π–ª:** `contexts/AuthContext.tsx`

–ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –ò–º–ø–æ—Ä—Ç `initializePushNotifications` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ `pushNotificationService`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `registerPushToken()` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–Ω–æ–Ω–∏–º–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- ‚úÖ –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω—ã–π —Ç–æ–∫–µ–Ω
- ‚úÖ –ü—Ä–∏ logout —Ç–æ–∫–µ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è

#### 3. Layout –æ–±–Ω–æ–≤–ª–µ–Ω
**–§–∞–π–ª:** `app/_layout.tsx`

–ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –ò–º–ø–æ—Ä—Ç `initializePushNotifications` –∏ `setupNotificationHandlers`
- ‚úÖ useEffect –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ push –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –î–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   ‚Üì
2. _layout.tsx ‚Üí initializePushNotifications(false)
   ‚Üì
3. –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ push
   ‚Üì
4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –æ—Ç Expo
   ‚Üì
5. POST /api/push/register-anonymous
   ‚Üì
6. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ anonymous_push_tokens
   ‚Üì
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏
```

### –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–µ:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è/–ª–æ–≥–∏–Ω–∏—Ç—Å—è
   ‚Üì
2. AuthContext ‚Üí registerPushToken(authToken)
   ‚Üì
3. initializePushNotifications(true, authToken)
   ‚Üì
4. POST /api/push/link-to-user
   ‚Üì
5. –ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ user
   ‚Üì
6. POST /api/push/register
   ‚Üì
7. –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ users.push_token
   ‚Üì
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏ + –¥–µ–¥–ª–∞–π–Ω—ã
```

---

## üìä –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ù–æ–≤–æ—Å—Ç–∏ üì∞
- **–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:** –í–°–ï (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ + –∞–Ω–æ–Ω–∏–º–Ω—ã–µ)
- **–§—É–Ω–∫—Ü–∏—è:** `push_service.send_news_to_all(db, title, body, data)`
- **–ü—Ä–∏–º–µ—Ä:**
  ```python
  push_service.send_news_to_all(
      db=db,
      title="–ù–æ–≤—ñ –∑–º—ñ–Ω–∏ –≤ –ø–æ–¥–∞—Ç–∫–æ–≤–æ–º—É –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤—ñ",
      body="–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –ø—Ä–æ –æ—Å—Ç–∞–Ω–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è...",
      data={"type": "news", "news_id": 123}
  )
  ```

### –î–µ–¥–ª–∞–π–Ω—ã üìÖ
- **–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:** –¢–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- **–§—É–Ω–∫—Ü–∏—è:** `push_service.send_deadline_notifications(db, title, body, data)`
- **–ü—Ä–∏–º–µ—Ä:**
  ```python
  push_service.send_deadline_notifications(
      db=db,
      title="–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –¥–µ–¥–ª–∞–π–Ω",
      body="–ß–µ—Ä–µ–∑ 3 –¥–Ω—ñ –∑–¥–∞—á–∞ –∑–≤—ñ—Ç–Ω–æ—Å—Ç—ñ",
      data={"type": "deadline", "days_left": 3}
  )
  ```

---

## üß™ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

### –¢–µ—Å—Ç 1: –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

1. **–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** (—á–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞)
2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ**
3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
4. **–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:** –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
5. **–†–∞–∑—Ä–µ—à–∏—Ç—å** push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:**
   ```
   ‚úÖ Push token obtained: ExponentPushToken[xxx]
   ‚úÖ Anonymous push token registered
   ```
7. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:**
   ```sql
   SELECT * FROM anonymous_push_tokens ORDER BY created_at DESC LIMIT 1;
   ```
   –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å

8. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
   ```bash
   curl -X POST http://localhost:8000/api/push/test \
     -H "Content-Type: application/json" \
     -d '{
       "title": "–¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è",
       "body": "–¶–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∞–Ω–æ–Ω—ñ–º–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
     }'
   ```

9. **–î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏** push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

### –¢–µ—Å—Ç 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –ø—Ä–∏–≤—è–∑–∫–æ–π —Ç–æ–∫–µ–Ω–∞

1. **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –¢–µ—Å—Ç–∞ 1** (–∞–Ω–æ–Ω–∏–º–Ω—ã–π —Ç–æ–∫–µ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
2. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:**
   ```
   ‚úÖ Anonymous token linked to user
   ‚úÖ User push token registered
   ```
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î:**
   ```sql
   -- –ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π
   SELECT * FROM anonymous_push_tokens WHERE is_linked_to_user IS NOT NULL;
   
   -- –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ users
   SELECT id, email, push_token FROM users WHERE email = 'test@example.com';
   ```

5. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ push –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö:**
   ```bash
   curl -X POST http://localhost:8000/api/push/test \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
     -d '{
       "title": "–î–µ–¥–ª–∞–π–Ω –∑–≤—ñ—Ç–Ω–æ—Å—Ç—ñ",
       "body": "–ß–µ—Ä–µ–∑ 3 –¥–Ω—ñ –∑–¥–∞—á–∞ –∑–≤—ñ—Ç–Ω–æ—Å—Ç—ñ"
     }'
   ```

6. **–î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏** push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### –¢–µ—Å—Ç 3: Logout –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π login

1. **–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (logout)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–¥–∞–ª–µ–Ω –∏–∑ users.push_token
3. **–í–æ–π—Ç–∏ —Å–Ω–æ–≤–∞** (login)
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** —Ç–æ–∫–µ–Ω —Å–Ω–æ–≤–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

### –¢–µ—Å—Ç 4: –†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –≤—Å–µ–º

1. **–í backend –∑–∞–ø—É—Å—Ç–∏—Ç—å:**
   ```python
   from app.services.push_notification import push_service
   from app.db.database import SessionLocal
   
   db = SessionLocal()
   
   result = push_service.send_news_to_all(
       db=db,
       title="–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –Ω–æ–≤–∏–Ω–∞",
       body="–¶–µ –≤–∞–∂–ª–∏–≤–∞ –Ω–æ–≤–∏–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤",
       data={"type": "news", "priority": "high"}
   )
   
   print(f"Sent: {result['success']}/{result['total']}")
   print(f"Registered users: {result['registered_users']}")
   print(f"Anonymous users: {result['anonymous_users']}")
   ```

2. **Push –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–π—Ç–∏:**
   - –í—Å–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
   - –í—Å–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Push –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–º
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend
docker logs eglavbuh_backend --tail 50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
docker exec eglavbuh_postgres psql -U eglavbuh_user -d eglavbuh_db \
  -c "SELECT COUNT(*) FROM anonymous_push_tokens;"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ frontend
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚úÖ Anonymous token linked to user"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
docker exec eglavbuh_postgres psql -U eglavbuh_user -d eglavbuh_db \
  -c "SELECT * FROM anonymous_push_tokens WHERE is_linked_to_user IS NOT NULL;"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –¢–æ–∫–µ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è
**–†–µ—à–µ–Ω–∏–µ:**
- –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ `initializePushNotifications`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `last_active_at` –≤ –ë–î - –¥–æ–ª–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

### Push —Ç–æ–∫–µ–Ω—ã –Ω–µ –±–µ—Å—Ä–æ—á–Ω—ã–µ
- –ú–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ú–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ iOS
- `initializePushNotifications` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å Celery task –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏:
```python
@celery_app.task
def cleanup_old_anonymous_tokens():
    """–£–¥–∞–ª–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π"""
    threshold = datetime.utcnow() - timedelta(days=90)
    db.query(AnonymousPushToken)\
      .filter(AnonymousPushToken.last_active_at < threshold)\
      .delete()
```

### Production deployment
–ü—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ production:
1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
2. ‚úÖ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π build iOS
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

---

## ‚úÖ Checklist –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] Backend: –ú–æ–¥–µ–ª—å AnonymousPushToken
- [x] Backend: –ú–∏–≥—Ä–∞—Ü–∏—è Alembic –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] Backend: API endpoints —Å–æ–∑–¥–∞–Ω—ã
- [x] Backend: –°–µ—Ä–≤–∏—Å —Ä–∞—Å—Å—ã–ª–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω
- [x] Frontend: pushService.ts —Å–æ–∑–¥–∞–Ω
- [x] Frontend: AuthContext –æ–±–Ω–æ–≤–ª–µ–Ω
- [x] Frontend: _layout.tsx –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü—Ä–∏–≤—è–∑–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
- [ ] Production: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä

---

**–≠—Ç–∞–ø 1 –∑–∞–≤–µ—Ä—à–µ–Ω! –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.** üéâ

**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –≠—Ç–∞–ø 2 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞ refresh tokens (iOS + Web)

