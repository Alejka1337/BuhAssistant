# Инструкция по тестированию Email Верификации

## Быстрый тест

### 1. Запуск бекенда
```bash
cd backend
# Убедитесь, что виртуальное окружение активировано
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. Запуск фронтенда
```bash
# В корне проекта
npx expo start
# Нажмите 'i' для iOS симулятора или 'a' для Android эмулятора
```

### 3. Тестирование флоу

#### Шаг 1: Регистрация
1. Откройте приложение
2. Нажмите "Зареєструватися"
3. Введите данные:
   - Email: `test@example.com`
   - Пароль: `password123`
   - Подтвердите пароль: `password123`
4. Нажмите "Зареєструватися"
5. ✅ Проверьте, что вас перенаправило на экран верификации

#### Шаг 2: Проверка email
1. Проверьте почту (если используете реальный email)
2. Найдите письмо от BuhAssistant
3. Скопируйте 6-значный код активации

#### Шаг 3: Верификация
1. На экране верификации введите код
2. Код должен автоматически переключаться между полями
3. ✅ Проверьте, что клавиатура не зависает
4. Нажмите "Підтвердити"
5. ✅ Должно появиться сообщение "Ваш email успішно підтверджено!"
6. ✅ Вас перенаправит на главный экран приложения

## Тестирование через API (для разработчиков)

### 1. Регистрация
```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "full_name": "Test User"
  }'
```

**Ожидаемый результат:**
```json
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "email": "test@example.com",
    "full_name": "Test User",
    "is_active": true,
    "is_verified": false,  // ❗ Обратите внимание
    ...
  }
}
```

### 2. Верификация (с кодом из email)
```bash
curl -X POST http://localhost:8000/api/auth/verify \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "code": "123456"
  }'
```

**Ожидаемый результат:**
```json
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "email": "test@example.com",
    "is_verified": true,  // ✅ Теперь true
    ...
  }
}
```

### 3. Повторная отправка кода
```bash
curl -X POST http://localhost:8000/api/auth/resend-code \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com"
  }'
```

## Проверка исправлений

### ✅ Исправление 1: 401 Unauthorized
**Как проверить:**
1. Зарегистрируйтесь
2. Подождите 1-2 минуты
3. Введите код верификации
4. Должно работать без ошибок 401

**Почему работает:** Endpoint больше не требует JWT токен

### ✅ Исправление 2: Зависание клавиатуры на iOS
**Как проверить:**
1. Откройте приложение на iOS симуляторе
2. Перейдите на экран верификации
3. Попробуйте ввести код:
   - Вводите по одной цифре
   - Используйте backspace для удаления
   - Вставьте код целиком из буфера обмена
4. Клавиатура должна работать плавно без зависаний

**Почему работает:** 
- Добавлены задержки перед переключением фокуса
- Добавлены специальные атрибуты для iOS

## Возможные ошибки и их решения

### Ошибка: "User not found"
**Причина:** Email не существует в базе данных
**Решение:** Проверьте, что вы используете правильный email из регистрации

### Ошибка: "Invalid activation code"
**Причина:** Неправильный код или опечатка
**Решение:** Проверьте код в письме, используйте "Відправити знову" для нового кода

### Ошибка: "Activation code expired"
**Причина:** Код истек (24 часа с момента генерации)
**Решение:** Используйте "Відправити знову" для получения нового кода

### Ошибка: "Email already verified"
**Причина:** Email уже верифицирован
**Решение:** Просто войдите в систему через экран логина

## Проверка в базе данных (PostgreSQL)

```sql
-- Проверить статус пользователя
SELECT id, email, is_verified, activation_code, activation_code_expires_at 
FROM users 
WHERE email = 'test@example.com';

-- До верификации:
-- is_verified = false
-- activation_code = '123456'
-- activation_code_expires_at = [дата в будущем]

-- После верификации:
-- is_verified = true
-- activation_code = NULL
-- activation_code_expires_at = NULL
```

## Логи для отладки

### Backend логи (в терминале с uvicorn):
```
INFO:     "POST /api/auth/register HTTP/1.1" 201 Created
INFO:     "POST /api/auth/verify HTTP/1.1" 200 OK
```

### Frontend логи (в Metro bundler или консоли браузера):
```
Verifying email: test@example.com
API endpoint: http://localhost:8000/api/auth/verify
Response status: 200
```

## Что дальше?

После успешной верификации:
1. Пользователь получает новые токены
2. Токены автоматически сохраняются в SecureStore
3. Пользователя перенаправляет на главный экран
4. Можно использовать все функции приложения

Для входа позже:
1. Используйте экран логина
2. Введите email и пароль
3. Система проверит, что email верифицирован
4. Если не верифицирован - вход будет заблокирован с сообщением "Email not verified"

