# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Push Notifications - Build #4

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è ‚úÖ
- Push —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚úÖ
- **–ù–û** —Ç–æ–∫–µ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î ‚ùå

**–õ–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞:**
```
User 2 has no push token registered
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `utils/pushNotificationService.ts` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–±—ã—á–Ω—ã–π `fetch()` –≤–º–µ—Å—Ç–æ `authenticatedFetch()`.

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
1. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞
2. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `ngrok-skip-browser-warning`
3. ‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–∏–π access token –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ Build #4

### 1. `utils/pushNotificationService.ts`

–ó–∞–º–µ–Ω–µ–Ω—ã **–≤—Å–µ** –≤—ã–∑–æ–≤—ã `fetch()` –Ω–∞ `authenticatedFetch()`:

#### `sendPushTokenToBackend()`
**–ë—ã–ª–æ:**
```typescript
const accessToken = await getAccessToken();
const response = await fetch(API_ENDPOINTS.PUSH.REGISTER, {
  headers: {
    Authorization: `Bearer ${accessToken}`,
  },
  ...
});
```

**–°—Ç–∞–ª–æ:**
```typescript
const response = await authenticatedFetch(API_ENDPOINTS.PUSH.REGISTER, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({ push_token: pushToken }),
});
```

#### –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- ‚úÖ `removePushTokenFromBackend()` - —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- ‚úÖ `getNotificationSettings()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ `updateNotificationSettings()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ `sendTestNotification()` - —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (—É–∂–µ –±—ã–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ)

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ push —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥:', pushToken);
console.log('Push-—Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', data);
```

### 3. –£–¥–∞–ª–µ–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç

```typescript
// –ë—ã–ª–æ:
import { getAccessToken, authenticatedFetch } from './authService';

// –°—Ç–∞–ª–æ:
import { authenticatedFetch } from './authService';
```

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Build #4

### –®–∞–≥ 1: –°–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ TestFlight

```bash
cd /Users/alejka1337/Desktop/buhassistant
eas build --platform ios --profile production
# –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (~15-20 –º–∏–Ω—É—Ç)
eas submit --platform ios --profile production --latest
```

### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ iPhone

1. –û—Ç–∫—Ä—ã—Ç—å **TestFlight**
2. –û–±–Ω–æ–≤–∏—Ç—å **eGlavBuh** –¥–æ Build #4
3. **–í–∞–∂–Ω–æ:** –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π (—á—Ç–æ–±—ã –∑–∞–Ω–æ–≤–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞

1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
3. –†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Allow)

**–õ–æ–≥–∏ Xcode/Metro (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥):**
```
–û—Ç–ø—Ä–∞–≤–∫–∞ push —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥: ExponentPushToken[XXXXXXXX]
Push-—Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {...}
```

**–õ–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞:**
```bash
docker-compose logs -f backend
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
Push token registered for user 2
```

### –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

1. **–ü—Ä–æ—Ñ—ñ–ª—å** ‚Üí **–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è**
2. **–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Alert: "–£—Å–ø—ñ—Ö! –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!"
- ‚úÖ Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ iPhone
- ‚úÖ –õ–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞: `Push notification sent successfully`

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–æ–∫–µ–Ω –∑–∞–ø–∏—Å–∞–ª—Å—è:

```bash
docker-compose exec backend python -c "
from app.db.database import get_db
from app.models.user import User

db = next(get_db())
user = db.query(User).filter(User.id == 2).first()
print(f'User: {user.email}')
print(f'Push Token: {user.push_token}')
print(f'Token type: {type(user.push_token).__name__}')
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
User: –≤–∞—à@email.com
Push Token: ExponentPushToken[XXXXXXXXXXXXXXXXXXXX]
Token type: str
```

---

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–æ–∫–µ–Ω –≤—Å—ë –µ—â—ë –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**

1. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ª–æ–≥–∏:**
   ```
   –û—Ç–ø—Ä–∞–≤–∫–∞ push —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥: ...
   ```
   –ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ—Ç ‚Üí —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å Expo

2. **–ë—ç–∫–µ–Ω–¥ –ª–æ–≥–∏:**
   ```
   POST /api/push/register HTTP/1.1" 200 OK
   ```
   –ï—Å–ª–∏ 400/401 ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

3. **–ü—Ä–∞–≤–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
   Settings ‚Üí eGlavBuh ‚Üí Notifications ‚Üí Allow Notifications: ‚úÖ

4. **Expo Project ID:**
   –í `app.json` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
   ```json
   "extra": {
     "eas": {
       "projectId": "8698ae71-7811-4098-ab40-e39b6dcffcf4"
     }
   }
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: 400 Bad Request –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–æ–∫–µ–Ω –≤ –ë–î, –Ω–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π.

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ
3. –í–æ–π—Ç–∏ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## üìã Checklist –¥–ª—è Build #4

- [x] `authenticatedFetch` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
- [x] –£–¥–∞–ª–µ–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç `getAccessToken`
- [x] `buildNumber` —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 4
- [x] `Info.plist` –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ë–∏–ª–¥ —Å–æ–±—Ä–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ TestFlight
- [ ] –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î
- [ ] –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - –î–µ–¥–ª–∞–π–Ω—ã (–∑–∞ 1 –∏ 3 –¥–Ω—è)
   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫/—á–µ—Ç–≤–µ—Ä–≥)

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Celery –∑–∞–¥–∞—á–∏:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ `celerybeat-schedule`
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å failed deliveries
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

---

## üöÄ –ó–∞–ø—É—Å–∫ –±–∏–ª–¥–∞

```bash
eas build --platform ios --profile production
```

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
```bash
eas submit --platform ios --profile production --latest
```

–ó–∞—Ç–µ–º —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤—ã—à–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! üéâ

