# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–æ—Ä—É–º–æ–º (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–æ–≤, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É:
```
Error: Could not validate credentials
```

–í –ª–æ–≥–∞—Ö –±–µ–∫–µ–Ω–¥–∞:
```
JWT decode error: Token has expired
```

**–ü—Ä–∏—á–∏–Ω–∞**: Access token –∏—Å—Ç–µ–∫–∞–ª —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç, –∏ –Ω–µ –±—ã–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ refresh token.

## –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `authenticatedFetch` –≤ `utils/authService.ts`

–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è `fetch`, –∫–æ—Ç–æ—Ä–∞—è:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç JWT —Ç–æ–∫–µ–Ω –∫ –∑–∞–ø—Ä–æ—Å—É
- ‚úÖ –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401 (Unauthorized) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `refreshAccessToken`
- ‚úÖ –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
- ‚úÖ –ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º refresh - –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–æ—Å–∏—Ç –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ

```typescript
export const authenticatedFetch = async (
  url: string,
  options: RequestInit = {}
): Promise<Response> => {
  // 1. –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∫ headers
  // 2. –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
  // 3. –ï—Å–ª–∏ 401 - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω
  // 4. –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
}
```

### 2. –û–±–Ω–æ–≤–ª—ë–Ω `utils/forumService.ts`

–í—Å–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ endpoint'—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `authenticatedFetch` –≤–º–µ—Å—Ç–æ `fetch`:

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ `createThread` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
- ‚úÖ `updateThread` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
- ‚úÖ `deleteThread` - —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ø–∏–∫–∞
- ‚úÖ `createPost` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- ‚úÖ `updatePost` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- ‚úÖ `deletePost` - —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- ‚úÖ `toggleLike` - –ª–∞–π–∫/–∞–Ω–ª–∞–π–∫
- ‚úÖ `getThreadById` - –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–ø–∏–∫–∞ (—Å fallback –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å `getThreadById`:**
–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –¥–ª—è –≥–æ—Å—Ç–µ–π, –ø–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ - –¥–µ–ª–∞–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π `fetch` –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤
- **Access Token**: 30 –º–∏–Ω—É—Ç (`ACCESS_TOKEN_EXPIRE_MINUTES=30`)
- **Refresh Token**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ access token

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
2. **authenticatedFetch** –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ SecureStore
3. **–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π** - –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω ‚úÖ
4. **–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫** (401):
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `refreshAccessToken()`
   - –ü–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π access token
   - –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SecureStore
   - –ó–∞–ø—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚úÖ
5. **–ï—Å–ª–∏ refresh token —Ç–æ–∂–µ –∏—Å—Ç—ë–∫**:
   - –£–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ —Ç–æ–∫–µ–Ω—ã
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ª–æ–≥–∏–Ω ‚ùå

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è:**
- üó£Ô∏è –§–æ—Ä—É–º (—Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤)
- üë§ –ü—Ä–æ—Ñ–∏–ª—å (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è)
- üì¨ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞)
- üìã –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ endpoint'—ã, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `authenticatedFetch`

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. **`utils/authService.ts`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `authenticatedFetch()`

2. **`utils/forumService.ts`**
   - –ò–º–ø–æ—Ä—Ç `authenticatedFetch`
   - –ó–∞–º–µ–Ω–∞ `fetch` –Ω–∞ `authenticatedFetch` –¥–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 30+ –º–∏–Ω—É—Ç (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å `ACCESS_TOKEN_EXPIRE_MINUTES` –Ω–∞ 1 –º–∏–Ω—É—Ç—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞)
3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ø–∏–∫ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: 
   - –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω
   - –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ: "Token expired, attempting to refresh..." ‚Üí "Token refreshed successfully"
   - –ù–µ –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è

### –õ–æ–≥–∏ –±–µ–∫–µ–Ω–¥–∞ (—É—Å–ø–µ—à–Ω—ã–π refresh):

```
INFO: 172.24.0.1:63618 - "POST /api/forum/posts HTTP/1.1" 401 Unauthorized
INFO: Token expired, attempting to refresh...
INFO: 172.24.0.1:63620 - "POST /api/auth/refresh HTTP/1.1" 200 OK
INFO: Token refreshed successfully
INFO: 172.24.0.1:63622 - "POST /api/forum/posts HTTP/1.1" 201 Created
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ù–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥** –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö - –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ service layer
2. **–î–ª—è –Ω–æ–≤—ã—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö endpoint'–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `authenticatedFetch` –≤–º–µ—Å—Ç–æ `fetch`
3. **–î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö endpoint'–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π `fetch` –∏–ª–∏ `getHeaders()`
4. **Refresh token** —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ SecureStore –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ refresh

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### ‚ùå –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–±–µ–∑ auto-refresh):
```typescript
const token = await getAccessToken();
const response = await fetch(`${API_URL}/api/forum/posts`, {
  method: 'POST',
  headers: {
    ...getHeaders(),
    'Authorization': `Bearer ${token}`,
  },
  body: JSON.stringify(data),
});
```

### ‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ (—Å auto-refresh):
```typescript
import { authenticatedFetch } from './authService';

const response = await authenticatedFetch(`${API_URL}/api/forum/posts`, {
  method: 'POST',
  body: JSON.stringify(data),
});
```

## –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –î–æ–±–∞–≤–∏—Ç—å retry logic –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
- [ ] –î–æ–±–∞–≤–∏—Ç—å queue –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ –≤—Ä–µ–º—è refresh
- [ ] –î–æ–±–∞–≤–∏—Ç—å preemptive refresh (–æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–∫–µ–Ω –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
- [ ] –î–æ–±–∞–≤–∏—Ç—å monitoring/analytics –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è token refresh rate

