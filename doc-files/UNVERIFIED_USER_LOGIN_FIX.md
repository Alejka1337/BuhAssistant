# Логин для невертифицированных пользователей

## Дата: 2025-11-15

## Проблема

Когда пользователь регистрируется, но не верифицирует email (не вводит код), при следующем входе он видит ошибку:
```
403 Forbidden: Email not verified. Please verify your email address.
```

Пользователь не может войти и не имеет возможности ввести код верификации.

## Решение

### 1. Backend изменения

**Файл:** `backend/app/api/auth.py`

Убрали блокировку входа для невертифицированных пользователей:

```python
# До:
if not user.is_verified:
    raise HTTPException(
        status_code=status.HTTP_403_FORBIDDEN,
        detail="Email not verified. Please verify your email address."
    )

# После:
# Не блокируем вход для невертифицированных пользователей
# Фронтенд проверит is_verified и перенаправит на экран верификации
```

### 2. Frontend изменения

#### AuthContext (`contexts/AuthContext.tsx`)

Изменили тип возвращаемого значения функции `login`:
```typescript
// До:
login: (credentials: LoginCredentials) => Promise<void>

// После:
login: (credentials: LoginCredentials) => Promise<AuthResponse>
```

Теперь возвращает данные пользователя, включая флаг `is_verified`.

#### Login Screen (`app/login.tsx`)

Добавили проверку после логина:

```typescript
const response = await login({ email, password });

// Если пользователь не верифицирован
if (!response.user.is_verified) {
  // Показываем диалог с выбором:
  Alert.alert(
    'Підтвердження email',
    'Ваш email ще не підтверджено. Бажаєте отримати новий код активації?',
    [
      { text: 'Ні, у мене є код' },  // Старый код еще действителен
      { text: 'Так, відправити код' }  // Отправить новый код
    ]
  );
}
```

## Флоу для пользователя

### Сценарий 1: Регистрация → Не ввел код → Вход позже

```
1. Пользователь регистрируется
   ├─ Email: user@example.com
   ├─ Получает код: 123456
   └─ НЕ вводит код (закрыл приложение)

2. Позже пользователь открывает приложение
   └─ Нажимает "Увійти"

3. Вводит email и пароль
   └─ Нажимает "Увійти"

4. Система проверяет is_verified = false
   └─ Показывает диалог:
      "Ваш email ще не підтверджено. Бажаєте отримати новий код?"
      
5. Пользователь выбирает:
   
   ВАРИАНТ А: "Ні, у мене є код"
   └─ Переход на экран верификации
   └─ Вводит старый код (если не истек)
   └─ ✅ Успешная верификация
   
   ВАРИАНТ Б: "Так, відправити код"
   └─ Отправляется новый код на email
   └─ Переход на экран верификации
   └─ Вводит новый код
   └─ ✅ Успешная верификация

6. После верификации
   └─ Пользователя перенаправляет на главный экран
```

### Сценарий 2: Код истек

```
1. Пользователь пытается войти (не верифицирован)
2. Выбирает "Ні, у мене є код"
3. Вводит старый код
4. ❌ Ошибка: "Activation code expired"
5. Нажимает "Відправити код знову" на экране верификации
6. Получает новый код
7. ✅ Успешная верификация
```

## Преимущества

1. ✅ **Гибкость:** Пользователь может использовать старый код (если не истек)
2. ✅ **Удобство:** Легко запросить новый код
3. ✅ **Понятность:** Четкие сообщения о том, что происходит
4. ✅ **Безопасность:** Коды все еще имеют срок действия (24 часа)

## Тестирование

### Тест 1: Вход с неверифицированным аккаунтом
```bash
# 1. Создайте пользователя через регистрацию
# 2. НЕ вводите код верификации
# 3. Закройте приложение
# 4. Откройте снова и нажмите "Увійти"
# 5. Введите email и пароль
# 6. ✅ Должен показать диалог с выбором
```

### Тест 2: Использование старого кода
```bash
# 1. Выберите "Ні, у мене є код"
# 2. Введите код из первоначального письма
# 3. ✅ Должно верифицировать успешно (если не истек)
```

### Тест 3: Запрос нового кода
```bash
# 1. Выберите "Так, відправити код"
# 2. ✅ Должно отправить новый код
# 3. ✅ Должно перейти на экран верификации
# 4. Проверьте почту
# 5. Введите новый код
# 6. ✅ Должно верифицировать успешно
```

## Изменённые файлы

1. `backend/app/api/auth.py` - убрана блокировка входа
2. `contexts/AuthContext.tsx` - изменен тип возврата `login`
3. `app/login.tsx` - добавлена проверка и диалог

## Примечания

- Старый код действителен 24 часа
- После верификации пользователь получает новые токены
- Можно запросить новый код неограниченное количество раз (TODO: добавить rate limiting)

