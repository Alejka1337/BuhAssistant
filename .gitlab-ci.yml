stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest

# Backend тесты
test:backend:
  stage: test
  image: python:3.11-slim
  before_script:
    - cd backend
    - pip install -r requirements.txt
  script:
    - pytest tests/ -v
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

# Build Docker образа для backend
build:backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $IMAGE_TAG -t $LATEST_TAG .
    - docker push $IMAGE_TAG
    - docker push $LATEST_TAG
  only:
    - main
    - develop
  except:
    - tags

# Deploy на EC2
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $EC2_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $EC2_USER@$EC2_HOST << 'EOF'
        cd /home/ubuntu/buhassistant
        
        # Pull последние изменения
        git pull origin main
        
        # Pull Docker образы
        docker-compose pull backend
        
        # Остановка старых контейнеров
        docker-compose down
        
        # Применение миграций
        docker-compose run --rm backend alembic upgrade head
        
        # Запуск новых контейнеров
        docker-compose up -d
        
        # Очистка старых образов
        docker system prune -af --filter "until=24h"
        
        echo "✅ Deployment completed successfully!"
      EOF
  only:
    - main
  when: manual  # Требует ручного подтверждения
  environment:
    name: production
    url: https://api.buhassistant.com

# Deploy на staging
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_STAGING" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $EC2_HOST_STAGING >> ~/.ssh/known_hosts
  script:
    - |
      ssh $EC2_USER@$EC2_HOST_STAGING << 'EOF'
        cd /home/ubuntu/buhassistant
        git pull origin develop
        docker-compose pull backend
        docker-compose down
        docker-compose run --rm backend alembic upgrade head
        docker-compose up -d
        echo "✅ Staging deployment completed!"
      EOF
  only:
    - develop
  environment:
    name: staging
    url: https://staging-api.buhassistant.com

